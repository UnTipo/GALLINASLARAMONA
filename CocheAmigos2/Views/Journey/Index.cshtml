@model CocheAmigos2.Models.JourneyMapModel
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<style>
    .ui-helper-hidden-accessible {
        display: none;
    }
</style>
<script type="text/javascript">

    $(function () {
        function split(val) {
            return val.split(/,\s*/);
        }
        function extractLast(term) {
            return split(term).pop();
        }

        $(".AutocompleteCityTo").bind("keydown", function (event) {
            if (event.keyCode === $.ui.keyCode.TAB &&
                $(this).data("autocomplete").menu.active) {
                event.preventDefault();
            }
        })
        $(".AutocompleteCityTo").autocomplete({
            source: function (request, response) {
                //define a function to call your Action (assuming UserController)
                $.ajax({
                    url: '/Main/GetMunicipios', type: "GET", dataType: "json",
                    //query will be the param used by your action method
                    data: { query: request.term },
                    term: extractLast(request.term),
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.name,
                                value: item.idmunicipio,
                                latitude: item.latitude,
                                longitude: item.longitude
                            };
                        }))
                    }
                })
            },
            search: function () {
                // custom minLength
                var term = extractLast(this.value);
                if (term.length < 3) {
                    return false;
                }
            },
            focus: function () {
                // prevent value inserted on focus
                return false;
            },
            select: function (event, ui) {
                this.value = ui.item.label;
                $("#IdCityTo").val(ui.item.value);
                $("#latitudeCityTo").val(ui.item.latitude);
                $("#longitudeCityTo").val(ui.item.longitude);
                return false;
            }
        });

        $(".AutocompleteCityFrom").bind("keydown", function (event) {
            if (event.keyCode === $.ui.keyCode.TAB &&
                $(this).data("autocomplete").menu.active) {
                event.preventDefault();
            }
        })
        $(".AutocompleteCityFrom").autocomplete({
            source: function (request, response) {
                //define a function to call your Action (assuming UserController)
                $.ajax({
                    url: '/Main/GetMunicipios', type: "GET", dataType: "json",
                    //query will be the param used by your action method
                    data: { query: request.term },
                    term: extractLast(request.term),
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.name,
                                value: item.idmunicipio,
                                latitude: item.latitude,
                                longitude: item.longitude
                            };
                        }))
                    }
                })
            },
            search: function () {
                // custom minLength
                var term = extractLast(this.value);
                if (term.length < 3) {
                    return false;
                }
            },
            focus: function () {
                // prevent value inserted on focus
                return false;
            },
            select: function (event, ui) {
                this.value = ui.item.label;
                $("#IdCityFrom").val(ui.item.value);
                $("#latitudeCityFrom").val(ui.item.latitude);
                $("#longitudeCityFrom").val(ui.item.longitude);

                return false;
            }
        });

    });

</script>

@using (Html.BeginForm())
{
    @Html.ValidationSummary(true)
    <fieldset>
        <legend>Journey Map</legend>

        @Html.TextBox("CityFrom", "", new { @class = "AutocompleteCityFrom" })
        <input id="BtnExchange" type="button" value="Exchange" />
        @Html.TextBox("CityTo", "", new { @class = "AutocompleteCityTo" })
        <input id="BtnSearch" type="submit" value="Buscar" />
        
        @Html.HiddenFor(model => model.IdCityFrom)
        @Html.HiddenFor(model => model.IdCityTo)
        
        @Html.HiddenFor(model => model.latitudeCityFrom)
        @Html.HiddenFor(model => model.longitudeCityFrom)

        @Html.HiddenFor(model => model.latitudeCityTo)
        @Html.HiddenFor(model => model.longitudeCityTo)

    </fieldset>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>
